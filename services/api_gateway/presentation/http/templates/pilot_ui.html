<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pilot Control UI</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #1f2937;
      --line: #374151;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --btn: #2563eb;
      --ok: #166534;
      --bad: #7f1d1d;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, Arial, sans-serif;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 14px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .grid2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }
    input, button {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
    }
    button {
      background: var(--btn);
      border-color: #1d4ed8;
      cursor: pointer;
    }
    button.secondary {
      background: var(--panel-2);
      border-color: var(--line);
    }
    button.confirm {
      background: var(--ok);
      border-color: #14532d;
      font-size: 18px;
      padding: 12px 24px;
    }
    button.reject {
      background: var(--bad);
      border-color: #7f1d1d;
      font-size: 18px;
      padding: 12px 24px;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .status {
      white-space: pre-wrap;
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }
    #frameWrap {
      position: relative;
      width: 100%;
      max-width: 780px;
    }
    #alertFrame {
      width: 100%;
      max-height: 620px;
      object-fit: contain;
      display: block;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #000;
    }
    #bboxOverlay {
      position: absolute;
      border: 3px solid #ef4444;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      display: none;
    }
    #alertMeta div {
      margin-bottom: 6px;
    }
    #emptyState {
      color: var(--muted);
      font-size: 16px;
      padding: 24px 0;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Mission</h2>
    <div class="row">
      <input id="sourceName" value="pilot-set" placeholder="source_name" />
      <input id="totalFrames" type="number" min="0" value="0" />
      <input id="fps" type="number" min="0" step="0.1" value="2.0" />
      <button onclick="createMission()">Create</button>
      <button class="secondary" onclick="startMission()">Start</button>
      <button class="secondary" onclick="completeMission()">Complete</button>
      <button class="secondary" onclick="loadReport()">Report</button>
    </div>
    <div class="row">
      <input id="missionId" class="mono" style="min-width:520px" placeholder="mission_id" />
      <label><input id="autoRefresh" type="checkbox" checked /> auto-refresh</label>
    </div>
    <div id="missionStatus" class="status"></div>
  </div>

  <div class="card">
    <h2>Auto stream from folder</h2>
    <div class="row">
      <input id="framesDir" style="min-width:520px" placeholder="/abs/path/to/frames" />
      <input id="labelsDir" style="min-width:420px" placeholder="/abs/path/to/labels (optional)" />
    </div>
    <div class="row">
      <input id="streamFps" type="number" min="0.1" step="0.1" value="2.0" />
      <input id="streamHighScore" type="number" min="0" max="1" step="0.01" value="0.95" />
      <input id="streamLowScore" type="number" min="0" max="1" step="0.01" value="0.05" />
      <button onclick="startStream()">Start stream</button>
      <button class="secondary" onclick="refreshStreamStatus()">Refresh stream status</button>
    </div>
    <div id="streamStatus" class="status"></div>
  </div>

  <div class="card">
    <h2>Operator queue (по одному алерту)</h2>
    <div class="row">
      <input id="reviewedBy" value="operator_1" placeholder="reviewed_by" />
      <input id="decisionReason" value="manual review" style="min-width:260px" placeholder="decision_reason" />
      <button class="secondary" onclick="refreshAlerts()">Refresh alerts</button>
    </div>

    <div id="emptyState">Нет алертов в очереди</div>

    <div id="alertBlock" style="display:none">
      <div class="grid2">
        <div>
          <div id="frameWrap">
            <img id="alertFrame" alt="alert frame" />
            <div id="bboxOverlay"></div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="confirm" onclick="reviewCurrent('confirm')">Подтвердить</button>
            <button class="reject" onclick="reviewCurrent('reject')">Отклонить</button>
          </div>
        </div>
        <div id="alertMeta">
          <div><strong>status:</strong> <span id="metaStatus"></span></div>
          <div><strong>timestamp:</strong> <span id="metaTs"></span></div>
          <div><strong>score:</strong> <span id="metaScore"></span></div>
          <div><strong>alert_id:</strong> <span id="metaAlertId" class="mono"></span></div>
          <div><strong>frame_id:</strong> <span id="metaFrameId"></span></div>
          <div><strong>bbox:</strong> <span id="metaBbox" class="mono"></span></div>
          <div><strong>explanation:</strong> <span id="metaExplanation"></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Mission report</h2>
    <pre id="reportBox" class="mono status">{}</pre>
  </div>
</div>

<script>
const api = '';
const alertSeenAt = new Map();
let currentAlert = null;

function missionId() {
  return document.getElementById('missionId').value.trim();
}

function nowSec() {
  return Date.now() / 1000;
}

async function createMission() {
  const payload = {
    source_name: document.getElementById('sourceName').value,
    total_frames: Number(document.getElementById('totalFrames').value),
    fps: Number(document.getElementById('fps').value),
  };
  const r = await fetch(api + '/v1/missions', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  const data = await r.json();
  document.getElementById('missionId').value = data.mission_id || '';
  document.getElementById('missionStatus').textContent = JSON.stringify(data, null, 2);
  await refreshAlerts();
}

async function startMission() {
  const r = await fetch(api + `/v1/missions/${missionId()}/start`, {method: 'POST'});
  document.getElementById('missionStatus').textContent = JSON.stringify(await r.json(), null, 2);
}

async function completeMission() {
  const r = await fetch(api + `/v1/missions/${missionId()}/complete`, {method: 'POST'});
  document.getElementById('missionStatus').textContent = JSON.stringify(await r.json(), null, 2);
}

async function startStream() {
  const id = missionId();
  if (!id) {
    alert('Create mission first');
    return;
  }
  const framesDir = document.getElementById('framesDir').value.trim();
  if (!framesDir) {
    alert('frames_dir is required');
    return;
  }
  const labelsDir = document.getElementById('labelsDir').value.trim();
  const payload = {
    frames_dir: framesDir,
    labels_dir: labelsDir || null,
    fps: Number(document.getElementById('streamFps').value),
    high_score: Number(document.getElementById('streamHighScore').value),
    low_score: Number(document.getElementById('streamLowScore').value),
    api_base: window.location.origin,
  };

  const r = await fetch(api + `/v1/missions/${id}/stream/start`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  document.getElementById('streamStatus').textContent = JSON.stringify(await r.json(), null, 2);
}

async function refreshStreamStatus() {
  const id = missionId();
  if (!id) return;
  const r = await fetch(api + `/v1/missions/${id}/stream/status`);
  document.getElementById('streamStatus').textContent = JSON.stringify(await r.json(), null, 2);
}

function setAlertVisible(visible) {
  document.getElementById('alertBlock').style.display = visible ? 'block' : 'none';
  document.getElementById('emptyState').style.display = visible ? 'none' : 'block';
}

function renderAlert(alert) {
  currentAlert = alert;
  if (!alertSeenAt.has(alert.alert_id)) {
    alertSeenAt.set(alert.alert_id, nowSec());
  }

  document.getElementById('metaStatus').textContent = alert.status;
  document.getElementById('metaTs').textContent = String(alert.ts_sec);
  document.getElementById('metaScore').textContent = String(alert.score);
  document.getElementById('metaAlertId').textContent = alert.alert_id;
  document.getElementById('metaFrameId').textContent = String(alert.frame_id);
  document.getElementById('metaBbox').textContent = (alert.bbox || []).join(', ');
  document.getElementById('metaExplanation').textContent = alert.explanation || '';

  const frame = document.getElementById('alertFrame');
  frame.onload = () => drawBbox(alert);
  frame.src = `/v1/alerts/${alert.alert_id}/frame`;
}

function drawBbox(alert) {
  const frame = document.getElementById('alertFrame');
  const overlay = document.getElementById('bboxOverlay');
  const bbox = alert.bbox || [];
  if (bbox.length !== 4 || !frame.naturalWidth || !frame.naturalHeight) {
    overlay.style.display = 'none';
    return;
  }

  const [x1, y1, x2, y2] = bbox.map(Number);
  const scaleX = frame.clientWidth / frame.naturalWidth;
  const scaleY = frame.clientHeight / frame.naturalHeight;

  overlay.style.left = `${x1 * scaleX}px`;
  overlay.style.top = `${y1 * scaleY}px`;
  overlay.style.width = `${Math.max((x2 - x1) * scaleX, 0)}px`;
  overlay.style.height = `${Math.max((y2 - y1) * scaleY, 0)}px`;
  overlay.style.display = 'block';
}

async function reviewCurrent(action) {
  if (!currentAlert) {
    return;
  }
  const seenAt = alertSeenAt.get(currentAlert.alert_id) || nowSec();
  const reaction = Math.max(nowSec() - seenAt, 0);
  const reviewedAtSec = Number((Number(currentAlert.ts_sec) + reaction).toFixed(3));

  const payload = {
    reviewed_by: document.getElementById('reviewedBy').value,
    reviewed_at_sec: reviewedAtSec,
    decision_reason: document.getElementById('decisionReason').value,
  };

  await fetch(api + `/v1/alerts/${currentAlert.alert_id}/${action}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });

  await refreshAlerts();
}

async function refreshAlerts() {
  const id = missionId();
  if (!id) {
    setAlertVisible(false);
    return;
  }

  const r = await fetch(api + `/v1/alerts?mission_id=${encodeURIComponent(id)}&status=queued`);
  const alerts = await r.json();
  if (!alerts.length) {
    currentAlert = null;
    setAlertVisible(false);
    return;
  }

  setAlertVisible(true);
  renderAlert(alerts[0]);
}

async function loadReport() {
  const r = await fetch(api + `/v1/missions/${missionId()}/report`);
  const data = await r.json();
  document.getElementById('reportBox').textContent = JSON.stringify(data, null, 2);
}

setInterval(() => {
  if (document.getElementById('autoRefresh').checked) {
    refreshAlerts();
    refreshStreamStatus();
  }
}, 1200);
</script>
</body>
</html>
