# Дизайн ML системы — Обнаружение людей на потоке с БПЛА (MVP)

## 1. Цели и предпосылки

### 1.1. Зачем идём в разработку продукта?

#### Бизнес-цель
Сократить время обнаружения человека оператором и повысить скорость его реакции при мониторинге видеопотока с БПЛА в ходе поисково-спасательных операций за счёт автоматических подсказок (детекций человека), чтобы оператор реагировал на события, а не выполнял сплошной визуальный поиск по кадрам.

#### Почему станет лучше, чем сейчас, от использования ML
- Вместо механического мониторинга потока внимание оператора освобождается для принятия решения и планирования дальнейших действий.
- Повышается оперативность реакции наземной поисковой группы.
- При том же составе смены возможно обработать больший объём данных или выполнить больше вылетов без резкого роста нагрузки на команду.
- Упрощается отчётность и дальнейший разбор полётов, так как результаты работы системы фиксируются в едином виде.

#### Критерии успеха итерации
##### 1) Ускорение обнаружения (снижение времени до подтверждения цели оператором)

Метрика Time-to-First-Confirm (TtFC) - сколько секунд нужно, чтобы заметить цель, когда она уже присутствует:
```math

TtFC = t_{\text{confirm}} - t_{\text{start}}

```
где:
- `t_confirm` — момент, когда оператор впервые подтверждает, что видит человека;
- `t_start` — момент, когда человек появляется в кадре.

Критерий успеха — относительное улучшение TtFC по сравнению с ручным мониторингом:


```math

\Delta TtFC =

\frac{\text{median}(TtFC_{\text{hand}}) - \text{median}(TtFC_{\text{model}})}

{\text{median}(TtFC_{\text{hand}})}

```

```math
\Delta TtFC \geq 0.25
```
где:

- `TtFC_hand` — TtFC при ручном мониторинге;
- `TtFC_model` — TtFC при использовании ML.

При ручном мониторинге значение `TtFC_hand` = **8,69 секунд**. Таким образом, улучшение считается устойчивым, если на более чем 50% пилотных миссий:

```math
\ TtFC_{\text{model}} \leq 6.52 \space с
```

---
##### 2) Полезность подсказок (полнота по эпизодам)

Важно, чтобы система хотя бы раз подсветила человека, когда он реально находится в кадре, чтобы помочь оператору быстро отреагировать. Иначе теряется смысл использования ML во время мониторинга.

Качество метрики оценивается на уровне эпизодов присутствия человека в кадре. 

**Эпизод** — это интервал времени, когда человек реально присутствует в кадре (GT).

Пусть в пилотном наборе есть `K` эпизодов появления человека, и для каждого известен интервал времени:

```math

[s_k, e_k], \quad k = 1,\dots,K

```
где:
- `s_k` — начало эпизода;
- `e_k` — конец эпизода;
- `k` — индекс эпизода.

**Алерт** — это событие, которое генерирует система, чтобы привлечь внимание оператора. Алерт считается по результатам агрегации детекций (bbox + порог уверенности + подтверждение на нескольких кадрах)

Пусть модель выдаёт алерты в моменты времени `t ∈ A`, где `A` — множество временных меток алертов. Эпизод `k` считается найденным, если хотя бы один алерт попал в его интервал (с допуском `τ` секунд):

```math

\text{found}_k =

\begin{cases}

1, & \exists t \in A: \ s_k - \tau \le t \le e_k + \tau \\

0, & \text{иначе}

\end{cases}

```

Критерий успеха — полнота по эпизодам:
```math

Recall_{\text{event}} = \frac{1}{K} \sum_{k=1}^{K} \text{found}_k

```

```math

Recall_{\text{event}} \geq 0.9

```
---
##### 4) Контроль ложных тревог

Система ограничивает количество ложных алертов, чтобы не повышать нагрузку на оператора из-за отвлечения на проверки подозрительных сигналов. Алерт считается ложным, если он не совпал ни с одним GT-эпизодом. Пороговое значение — 2 ложных алерта на 5 минут миссии, следовательно в минуту:
```math
\ FP/min \leq 0.4
```

---
### 1.2. Бизнес-требования и ограничения
#### Бизнес-требования
Система должна поддерживать применение БПЛА в поисково-спасательных операциях в режиме мониторинга видеопотока и помогать оператору за счёт автоматических подсказок о вероятном присутствии человека. Результат работы — снижение времени до первого подтверждения цели при сохранении высокой вероятности не пропустить человека.

По функционалу решение предполагает:
- получение видеопотока с БПЛА или видеозаписи миссии;
- формирование подсказок оператору в виде событий/алертов с детекцией человека (класс `Person`) и временными метками;
- минимально достаточную визуализацию для принятия решения (кадр + bbox + таймкод);
- фиксацию показателей в отчёте по миссии (срабатывания, базовые сводные показатели), пригодном для последующего разбора полёта.

#### Бизнес-ограничения
- Подсказки должны приходить достаточно быстро, чтобы их можно было использовать по ходу миссии.
- Количество алертов должно быть ограничено, чтобы оператор мог продолжать управление миссией.
- Пилот предполагает работу без облачной инфраструктуры.
- Эффект должен подтверждаться на нескольких миссиях, а не на одном демонстрационном примере.

#### Что ожидаем от конкретной итерации
MVP для пилота, который можно использовать в операторском контуре без ручной настройки в полевых условиях: единый сценарий запуска, понятный интерфейс отображения подсказок и фиксируемый результат работы в виде отчёта и логов. Система позволяет воспроизводимо провести испытания на нескольких миссиях и собрать данные, достаточные для расчёта метрик из пункта 1.1 и принятия решения о дальнейшем развитии и продуктивизации решения.

#### Описание бизнес-процесса пилота
Пилот проводится на наборе миссий в виде последовательных потоков кадров фиксированной длительности с временными метками и  GT-разметкой присутствия человека. Для обеспечения сопоставимости результатов перед пилотом фиксируются версия модели, параметры инференса и правила формирования алертов:

- порог уверенности детекции `conf_thr = 0.2` 
- размер окна агрегации по времени `W = 1 сек`
- минимальное количество срабатываний в окне `k = 2` 
- минимальный интервал между алертами `cooldown = 3 сек` 
- разрыв эпизода `τ_gap_end = 1 сек` (если цель пропала дольше, считаем алерт завершенным)

 Каждый алерт имеет временную метку и используется как продуктовая подсказка о вероятном присутствии человека.

Качество пилота оценивается по метрикам, рассчитываемым по результатам прогона каждой миссии и затем агрегируемым по всему набору миссий. Метрика `TtFC` определяется как разница между началом **первого GT-эпизода** появления человека и подтверждением **первого алерта**, который пересёкся с этим эпизодом (с допуском ±τ секунд).

Например, человек присутствует в двух эпизодах (`s - start`, `e - end`, `t - timestamp` считаются относительно начала миссии):

- Эпизод 1: `s1 = 10.0 c`, `e1 = 18.0 c` 
- Эпизод 2: `s2 = 40.0 c`, `e2 = 46.0 c`

Система присылает алерты с метками времени:
- `t = 8.5 c`
- `t = 12.3 c`
- `t = 41.0 c`

Пусть допуск `τ = 1.0 c`. Тогда допустимый интервал для эпизода 1 — `[9.0 c, 19.0 c]`

В этот интервал попал только алерт `12.3 c`, так как  `8.5 c` <  `9.0 c`, а `41.0 c` относится к другому эпизоду. Оператору в среднем нужно `2.5 c` для принятия решения и подтверждения после алерта, тогда:

```math
TtFC = t_{\text{confirm}} - t_{\text{start}} = t - s_{1} + 2.5 = 12.3 - 10.0 + 2.5 = 4.8 \ с
```

То есть система среагировала через 2.3 секунды после начала появления человека в кадре, а общее время до подтверждения составило 4.8 секунды.

Метрика `Recall_event`рассчитывается как доля найденных эпизодов от общего числа эталонных эпизодов по миссии. Для контроля нагрузки фиксируется количество ложных тревог `FP/мин ≤ 0.4`

По завершении пилота система формирует отчёт, включающий: список алертов с временными метками и оценкой корректности относительно эпизодов, рассчитанные значения `TtFC`, `Recall_event` и показателя ложных тревог по каждой миссии, а также сводную агрегацию по всему пилотному набору. Полученные результаты используются для принятия решения о готовности текущей конфигурации алертинга и порогов к дальнейшей итерации или внедрению, а также для выбора направлений улучшений (изменение порога, правил агрегации, дообучение модели на характерных сценариях пропусков/ложных срабатываний).

#### Критерии успеха пилота
```math
\ TtFC_{\text{model}} \leq 6.52 \space с
```
```math

Recall_{\text{event}} \geq 0.9,

```
```math
\ FP/min \leq 0.4
```

Успешный пилот — это пилот, в котором на >50% миссий есть измеримое улучшение по бизнес-метрикам процесса относительно ручного режима. Улучшение не достигается ценой пропусков цели, а частота ложных тревог остаётся управляемой для оператора. Система работает без критичных задержек и без опоры на облако, формирует понятные отчёты для разбора.

#### Возможные пути развития после пилота
- улучшение качества детекции;
- калибровка режимов чувствительности для разных условий окружающей среды;
- оптимизация под целевое железо (коммерчески доступные одноплатные компьютеры типа RaspberryPi 4B и Orin Nano);
- при возможности — интеграция с внешними системами и датчиками на дроне.

---
### 1.3. Что входит в скоуп проекта/итерации, что не входит

#### На закрытие каких БТ подписываемся в данной итерации
- Детекция класса `Person` на видеопотоке/кадрах с управляемой настройкой порога уверенности и выдачей результата в UI.
- Формирование подсказок в виде алертов с временными метками.
- Воспроизводимая оценка качества и производительности на наборе миссий для принятия решения по следующей итерации.

#### Что не будет закрыто
- интеграция с дополнительными датчиками на борту, в том числе ночной поиск с использованием тепловизионных данных;
- автономное принятие решений уровня полётного контроллера;
- гарантированная точность геопривязки к координатам на карте без внешних источников.

#### Описание результата с точки зрения качества кода и воспроизводимости решения
Воспроизводимое пилотное end-to-end решение в виде репозитория с фиксированными зависимостями, понятными точками запуска и конфигурациями; воспроизводимый пайплайн обучения/оценки и единый формат отчётов; зафиксированные версии датасета/разметки, весов модели и параметров инференса. Воспроизводимость подразумевает, что на одном и том же наборе пилотных миссий при одинаковых конфигурациях получаются сопоставимые метрики эффекта и отчёт пилота, а также сохраняются логи алертов и решений оператора.

#### Описание планируемого технического долга
Полный набор оптимизаций под устройства типа Raspberry Pi и Orin Nano (квантизация, прореживание, оптимизации на уровне рантайма); авторизация и разделение прав на сервисе.

---
### 1.4. Предпосылки решения

Модель работает в режиме обработки видеопотока: горизонт принятия решения — текущий кадр/короткий интервал времени. Продуктовый результат и бизнес-метрики считаются на уровне алертов, потому что именно так измеряется нагрузка на оператора и полезность подсказок в процессе миссии.

- Данные: для обучения и проверки используются размеченные данные, собранные совместно с ДПСО «ЛизаАлерт» в рамках технологических конкурсов (около 60 000 изображений людей в природной среде; различные регионы/сезоны/погода).
- Предполагается, что человек в кадре может быть малым объектом на сложном фоне (лес/поле), возможны частичные перекрытия, различия по высоте полёта, освещению и погоде.
- Предполагается локальный контур обработки без облачной инфраструктуры;
- Стек: дообученный детектор на базе YOLO-подхода с последующей постобработкой (ROI-каскад, трекинг, фильтры временной устойчивости), сервисный слой на FastAPI.

---

## 2. Методология (Data Scientist)

### 2.1. Постановка задачи
С технической точки зрения решается задача **детекции** объекта класса `Person` (человек) на кадрах c дрона (на продуктовом слое кадры агрегируются в алерты)

Основная цель обучения - максимизация полноты (Recall) при контроле ложных тревог.

---
### 2.2. Блок-схема решения
```mermaid
%%{init: {"flowchart": {"curve": "linear"}, "theme": "base"} }%%
flowchart LR

E0["**Этап 0**<br/>**Подготовка данных**<br/>Фиксация теста и сплита по миссиям<br/>Распределения bbox<br/>Доля негативов и мелких объектов"]
E2["**Этап 2**<br/>**Интерпретация и калибровка**<br/>Анализ ошибок<br/>Калибровка порогов<br/>Проверка сценариев"]
E3["**Этап 3**<br/>**Постобработка и бизнес-метрики**<br/>Детекции → алерты<br/>Правила формирования алертов<br/>Recall_event, FP/min, TtFC"]
E5["**Этап 5**<br/>**Интеграция**<br/>Поток кадров с RaspberryPi<br/>API инференса<br/>UI (алерты/взаим.)<br/>Логи миссий"]
E6["**Этап 6**<br/>**Оптимизатор**<br/>Выбор итерации по метрикам<br/>Баланс Recall_event и FP/min"]
E7["**Этап 7**<br/>Подготовка к пилоту<br/>Фиксация конфигов<br/>Манифест миссии<br/>Шаблон отчёта"]

subgraph S1[" "]
direction TB
B1["**Этап 1 — Baseline**<br/>**Подготовка модели**<br/>YOLOv8n<br/>Фикс. разрешение<br/>Стандартный пайплайн"]
M1["**Этап 1 — MVP**<br/>**Подготовка модели**<br/>YOLOv8n<br/>Multi-scale обучение<br/>Аугментации<br/>Сравнение с бейзлайном"]
end

subgraph S4[" "]
direction TB
B4["**Этап 4 — Baseline**<br/>**Простой инференс**<br/>Одна модель<br/>Фикс. пороги<br/>Без оптимизаций"]
M4["**Этап 4 — MVP**<br/>**Инференс итерациями**<br/>Сбор системных метрик<br/>ROI-каскад (мелкие объекты)"]
end

E0 --> B1
E0 --> M1
B1 --> E2
M1 --> E2

E2 --> E3

E3 --> B4
E3 --> M4
B4 --> E5
M4 --> E5

E5 --> E6 --> E7

classDef stageBlue fill:#D9E8FF,stroke:#6B8CC7,stroke-width:1px,color:#0b1b33;
classDef stageGreen fill:#DFF3DF,stroke:#6FB56F,stroke-width:1px,color:#0b1b33;
classDef stageOrange fill:#F8E4C2,stroke:#C9A35A,stroke-width:1px,color:#0b1b33;

class E0,E2,E3,E5,E6 stageBlue;
class E7,M1,M4 stageGreen;
class B1,B4 stageOrange;

style S1 fill:transparent,stroke:transparent
style S4 fill:transparent,stroke:transparent
```


### 2.3. Этапы решения задачи (Data Scientist)

#### 2.3.0. Этап 0 — подготовка и проверка данных

| Название данных               | Есть ли данные / источник | Требуемый ресурс | Проверено ли качество |
| ----------------------------- | ------------------------- | ---------------- | --------------------- |
| Кадры                         | ДПСО «ЛизаАлерт»          | DS/ML            | Проверена целостность файлов |
| Аннотации bbox в YOLO-формате | ДПСО «ЛизаАлерт»          | DS/ML            | Проверена корректность аннотаций |

Результаты автоматических проверок по сплитам:

| Выборка | Всего кадров | Всего bbox | Кадры без bbox | Доля кадров без bbox | bbox с нулевыми размерами | bbox за пределами кадра | bbox с неизвестным классом | Мелких объектов |
| :------ | :----------- | :--------- | :------------- | :------------------- | :------------------------ | :---------------------- | :------------------------- | :-------------- |
| test    | 50538        | 41481      | 20531          | 0.406249             | 0                         | 0                       | 0                          | 21808           |
| train   | 8484         | 6827       | 4398           | 0.518388             | 0                         | 0                       | 0                          | 6807            |
| val     | 1000         | 1763       | 294            | 0.294000             | 0                         | 0                       | 0                          | 1671            |

В исходном датасете тестовая выборка гораздо больше тренировочной и содержит большое количество негативных кадров (без человека), собранных с потока реальной миссии. Эти кадры используются не как стандартный тест для оценки качества модели после обучения, а для проверки устойчивости всего пайплайна и приближенной оценки эксплуатационных метрик, чувствительных к негативам (например, частоты ложных алертов). Для обучения и контроля качества модели выборки формируются как:

- **Train** - 80% от `train+val` (**7588** изображений),
- **Val** - 10% от `train+val` (**948** изображений),
- **Holdout (test)** - 10% от `train+val` (**948** изображений),

при этом кадры и разметка, полученные в рамках одной миссии, находятся строго внутри одного сплита, чтобы избежать утечки соседних кадров, поэтому возможно изменение соотношений по сплитам на 2-3%.

| Часть данных                    | Что нужно проверить                                                                                                          |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **Кадры без bbox** (негативные) | Доля негативов в `Val` не отличается существенно от ожидаемого рабочего потока                                               |
| **Кадры с bbox** (позитивные)   | Распределение плотности людей на кадрах в `Val` отражает распределение в `Train/Holdout/test`                                |
|                                 | Распределение размеров bbox в `Val` сопоставимо с `Train/Holdout/test`                                                       |
|                                 | Нет выраженного смещения положения объектов к центру или к краям кадров                                                      |
|                                 | Распределение соотношения сторон bbox в `Val` сопоставимо с `Train/Holdout/test` (нет аномально вытянутых разметок/выбросов) |
|                                 | Доля мелких объектов (<0.1% кадра) требует заложения отдельной стратегии обучения (SAHI, ROI-каскад, мульти-скейл)           |

**Таргет:** bbox человека в формате YOLO:

```math
\langle class\_id, x, y, w, h\rangle
```

где `x,y` — центр bbox, `w,h` — ширина/высота; все величины нормированы в долях ширины/высоты изображения.

#### 2.3.1. Этап 1 — подготовка моделей детекции

| Компонент         | Baseline                                       | MVP                                                                              |
| ----------------- | ---------------------------------------------- | -------------------------------------------------------------------------------- |
| Архитектура       | YOLOv8n (детектор `Person, class 0`)           | YOLOv8n (детектор `Person, class 0`)                                             |
| Разрешение        | 640×640                                        | Multi-scale 640-1280                                                             |
| Пайплайн обучения | Стандартный набор аугментаций flip/scale/color | Подбор аугментаций под миссии, акцент на мелких объектах (P2(4) в голове модели) |
| Выход этапа       | Baseline-веса и протокол обучения              | Лучшая MVP-итерация обучения и сравнительная таблица метрик                      |

Сравниваем Baseline и MVP по метрикам:
- `mAP50`,
- `mAP50-95`,
- `Precision`,
- `Recall`,
- `F1`

**Гранулярность и горизонт:** На ML‑уровне модель решает задачу детекции на кадре (выдает bbox и score); на продуктовом уровне качество оценивается через события (алерты) в ходе миссии, итоговые метрики TtFC, Recall_event, FP/min считаются по миссии.

**Риски:** Рост FP на при попытке повысить recall на микро‑целях (снижается последующей калибровкой постобработки)

#### 2.3.2. Этап 2 — интерпретация результатов и калибровка порогов

На этом этапе проводится ошибка‑анализ на уровне миссий и калибровка параметров инференса (confidence, NMS), чтобы поведение детектора соответствовало продуктовым ограничениям по ложным тревогам и обеспечивало устойчивый `Recall_event`.

| Компонент     | Baseline                                     | MVP                                                                               |
| ------------- | -------------------------------------------- | --------------------------------------------------------------------------------- |
| Анализ ошибок | Быстрый просмотр типовых FP/FN               | Анализ по миссиям и срезам условий (высота, размер объекта, пересвет, перекрытия) |
| Калибровка    | Стандартные пороги для стабильного инференса | Калибровка порогов под целевые бизнес-метрики  (`FP/min`, `Recall_event`)         |
| Выход этапа   | Фиксированные Baseline-пороги                | Откалиброванные пороги/режимы и перечень типовых ошибок с причинами               |

#### 2.3.3. Этап 3 — бизнес-правила формирования алертов и расчёт бизнес-метрик

Поскольку продуктовой единицей является **алерт**, вводим слой бизнес‑правил, преобразующий детекции в события. На этом слое рассчитываем целевые метрики `TtFC`, `Recall_event`, `FP/min`, фиксируем параметры постобработки для пилотной итерации MVP:

- порог уверенности детекции `conf_thr = 0.2` 
- размер окна агрегации по времени `W = 1 сек`
- минимальное количество срабатываний в окне `k = 2` 
- минимальный интервал между алертами `cooldown = 3 сек` 
- разрыв эпизода `τ_gap_end = 1 сек` (если цель пропала дольше, считаем алерт завершенным)

**Метрика ложных тревог:**

```math

FP/\min = \frac{N_{\text{false alerts}}}{T_{\text{mission}}/60}

```

где `N_false alerts` — число алертов вне GT‑эпизодов (с учётом допуска), `T_mission` — длительность миссии в секундах.

| Компонент         | Baseline                               | MVP                                                            |
| ----------------- | -------------------------------------- | -------------------------------------------------------------- |
| Правила алертинга | 1 детекция с `conf_thr > 0.2`= 1 алерт | Контракт пилота: `conf_thr`, `W`, `k`, `cooldown`, `τ_gap_end` |
| Метрики           | `Recall_event`, `FP/min`, `TtFC`       | `Recall_event`, `FP/min`, `TtFC`                               |
| Выход этапа       | Baseline-конфиг алертинга              | MVP-конфиг алертинга                                           |

**Риски:** Слишком жёсткие правила уменьшают `Recall_event`, слишком мягкие повышают `FP/min` - компромисс выбираем на этапе 6 (оптимизатор)

#### 2.3.4. Этап 4 — подготовка инференса по итерациям

На данном этапе готовим практический режим инференса и замеряем системные характеристики, необходимые для пилота:
- `p50/p95 latency`,
- `FPS`,
- `Inference Time`

| Компонент   | Baseline                              | MVP                                                        |
| ----------- | ------------------------------------- | ---------------------------------------------------------- |
| Инференс    | Одна модель с фиксированными порогами | Итерации инференса с разными конфигами                     |
| Улучшения   | Без оптимизаций                       | ROI-каскад для мелких объектов при необходимости           |
| Выход этапа | Baseline-режим инференса              | Набор итераций с измерениями качества и производительности |

#### 2.3.5. Этап 5 — интеграция источника потока кадров и интерфейса

На этом этапе собираем end-to-end контур «поток кадров - инференс - логирование - отчет по миссии»

| Компонент       | Baseline                                     | MVP                                                             |
| --------------- | -------------------------------------------- | --------------------------------------------------------------- |
| Источник данных | Поток в офлайне для воспроизводимых прогонов | Поток кадров с RaspberryPi 4B                                   |
| Интеграция      | Вывод bbox/алертов                           | API инференса + пользовательский интерфейс и логирование миссий |
| Выход этапа     | Рабочий прототип контура                     | Пилотный контур с логами и артефактами для расчета метрик       |

#### 2.3.6. Этап 6 — выбор оптимальной итерации

Выбираем конфигурацию, которая обеспечивает максимальную полезность алертов при соблюдении ограничений на ложные тревоги. Формально критерий отбора записывается как:

```math
i^*=\arg\max_i ; Recall_{event}^{(i)}  
\quad \text{при условиях} \quad  
Recall_{event}^{(i)} \ge 0.9,;  
FP/\min^{(i)} \le 0.4  
```
где `i` — индекс итерации (модель + параметры инференса + постобработка)

Если две конфигурации имеют одинаковое значение Recall_event, выбираем версию с меньшей p95-latency, чтобы система была более отзывчивой в пилоте.

| Компонент    | Baseline                            | MVP                                                 |
| ------------ | ----------------------------------- | --------------------------------------------------- |
| Выбор версии | Вручную по таблице метрик           | Формальный критерий отбора и контрольные миссии     |
| Выход этапа  | Baseline-конфигурация нулевой точки | Выбранная конфигурация для пилота и протокол выбора |

**Риски:** ни одна из версий не достигнет целевого значения Recall_event. В этом случае выбираем лучшую по recall при FP/min ≤ 0.4 и фиксируем разницу до цели 0.9 как план работ, либо временно ослабляем порог 0.9 для MVP, но обязуемся закрыть в следующей итерации.

#### 2.3.7. Этап 7 — подготовка финального отчёта и артефактов

На этом этапе формируем пакет артефактов, обеспечивающий воспроизводимый запуск пилотной проверки и сопоставимость результатов между итерациями:

- зафиксированная версия модели и параметры инференса, 
- конфигурация постобработки (правила формирования алертов),
- манифест набора миссий (список фрагментов, длительность, пути),
- шаблон отчёта по миссии и агрегирующего отчёта по набору миссий в едином формате со структурой полей:
	- список алертов с временными метками и разметкой TP/FP относительно GT-эпизодов,
    - `TtFC`, `Recall_event`, `FP/min` по миссии,
    - агрегация метрик по набору миссий

**Выход этапа:** Версионированный пакет, который далее используется для проведения пилота, и возможные рекомендации по улучшению.

---

## 3. Подготовка пилота

### 3.1. Способ оценки пилота

Проводим пилот на наборе из 12 миссий, представленных как последовательности кадров фиксированной длительности с временными метками и GT-разметкой эпизодов присутствия человека. Перед запуском пилота фиксируем версию модели, параметры инференса и правила формирования алертов:

- `conf_thr = 0.2`,
- `W = 1 сек`,
- `k = 2`,
- `cooldown = 3 сек`,
- `τ_gap_end = 1 сек`.

Единицей продуктовой оценки является **алерт** — событие с временной меткой, получаемое агрегацией детекций по времени. Качество пилота оцениваем по метрикам каждой миссии, затем агрегируемым по всему пилотному набору.

Метрика **TtFC** в пилоте — разница между началом **первого GT-эпизода** появления человека и моментом подтверждения **первого алерта**, который пересёкся с этим эпизодом (с допуском `±τ`). Подтверждение после алерта моделируется фиксированным временем принятия решения оператором `2.5 c`, поэтому:

```math
TtFC = t - s_1 + 2.5 \text{ c}
```

где:
- `s_1` — начало первого GT-эпизода,
- `t` — временная метка первого алерта, попавшего в первый GT-эпизод с допуском `±τ`.

### 3.2. Что считаем успешным пилотом

Пилот считается успешным, если одновременно выполняются условия:

1. **Ускорение обнаружения (TtFC)**  
   Относительное улучшение медианного времени на 25%:

```math
\Delta TtFC \geq 0.25
```

Численно порог для устойчивого улучшения (на более чем 50% миссий пилота) равен:

```math
TtFC_{\text{model}} \leq 6.52 \text{ c}
```

2. **Полезность подсказок на уровне эпизодов (Recall_event)**  
   Эпизод `k` считается найденным, если хотя бы один алерт попал в его интервал (с допуском `τ` секунд), и:

```math
Recall_{\text{event}} = \frac{1}{K} \sum_{k=1}^{K} \text{found}_k \geq 0.9
```

3. **Контроль ложных тревог (FP/min)**  
   Частота ложных алертов не должна превышать `0.4` в минуту:

```math
FP/\min \leq 0.4
```

что соответствует не более 2 ложным алертам на 5 минут миссии.

Таким образом, успешный пилот — это пилот, в котором более чем на 50% миссий достигается измеримое улучшение по метрике TtFC при одновременном выполнении ограничений по метрикам Recall_event и FP/min, без критичных задержек и без опоры на облачную инфраструктуру.

### 3.3. Подготовка пилота

**1) Фиксируем артефакты и конфиги пилота**  
До запуска фиксируются:
- веса модели (точная версия/хэш артефакта);
- параметры инференса и NMS;
- контракт алертинга (`conf_thr`, `W`, `k`, `cooldown`, `τ_gap_end`) и допуск `τ = 1 c` для пересечения с GT-эпизодами;
- манифест пилотных миссий (список фрагментов, длительность, пути);
- единый формат логов и отчётов.

**2) Перепроверяем вычислительную применимость выбранного конфига**  
Перед запуском пилота выбранная на Этапе 6 конфигурация должна удовлетворять ограничениям по производительности, измеренным на Этапе 4 (`p50/p95 latency`, `FPS`, `Inference Time`). Если конфигурация не обеспечивает стабильную обработку потока без критичных задержек, пилот считается некорректным (результаты неинтерпретируемы), и нужен возврат к выбору другой итерации/упрощению пайплайна.

**3) Фиксируем правило применения контракта**  
В ходе пилота запрещены изменения конфигурации, влияющие на формирование алертов и расчёт метрик. Зафиксированный в п. 3.3 (п. 1) контракт алертинга и выбранная на Этапе 6 конфигурация применяются неизменно ко всем миссиям пилотного набора. Любое изменение конфигурации допускается только вне пилота и оформляется как новая версия с отдельным прогоном и отчётом.

**4) Готовим отчёт по пилоту**  
По завершении прогона система формирует отчёт по каждой миссии и сводную агрегацию по пилотному набору (12 миссий): список алертов с временными метками и классификацией TP/FP относительно GT-эпизодов, значения `TtFC`, `Recall_event`, `FP/min` и агрегаты по всему набору миссий. Эти результаты используются для решения о готовности конфигурации и выборе направлений улучшений (порог, правила агрегации, дообучение по типовым FP/FN).
